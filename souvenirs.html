<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Souvenirs</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="page-souvenirs">
    <div class="background-balls">
        <div class="big-ball ball-1"></div>
        <div class="big-ball ball-2"></div>
        <div class="big-ball ball-3"></div>
    </div>
    <!-- Menu principal fixe (haut-gauche) -->
    <nav class="main-menu" role="navigation" aria-label="Menu principal">
        <button class="btn-home" onclick="window.location.href='index.html'" aria-label="Menu principal">â˜° Menu</button>
    </nav>
    <div class="container">
        <h2 class="page-title">Nos souvenirs</h2>
        
        <!-- Carrousel 3D -->
        <div class="carousel-wrapper">
            <div class="carousel-container" id="carouselContainer">
                <div class="carousel-track" id="carouselTrack">
                    <!-- Les photos seront chargÃ©es dynamiquement -->
                </div>
            </div>
            
            <!-- Navigation -->
            <button class="carousel-btn carousel-btn-prev" id="prevBtn" aria-label="Photo prÃ©cÃ©dente">
                <span>â€¹</span>
            </button>
            <button class="carousel-btn carousel-btn-next" id="nextBtn" aria-label="Photo suivante">
                <span>â€º</span>
            </button>
            
            <!-- Indicateurs -->
            <div class="carousel-indicators" id="indicators"></div>
        </div>
        
        <!-- Personnages Sanrio -->
        <div class="sanrio-characters">
            <img src="asset/sanrio/2.png" alt="" class="sanrio-char pos-5">
            <img src="asset/sanrio/ku.png" alt="" class="sanrio-char pos-6">
        </div>
        
        <!-- Toggle musique -->
        <button class="music-toggle" id="musicToggle" aria-label="Toggle musique">
            <span class="music-icon">ðŸŽµ</span>
            <span class="music-status">ON</span>
        </button>
        
        <!-- Bouton vers le message final (dÃ©clenche paillettes puis navigation) -->
        <button class="btn-next" id="btnNextToFinal">Lire le message</button>
    </div>

    
    <!-- Conteneur pour paillettes (ne modifie pas le layout) -->
    <div class="confetti-container" id="confettiContainer" aria-hidden="true"></div>

    <!-- Overlay pour les messages -->
    <div class="overlay" id="overlay">
        <div class="overlay-content">
            <button class="overlay-close" onclick="closeOverlay()">&times;</button>
            <div id="overlayMedia" class="overlay-media"></div>
            <p class="overlay-message" id="overlayMessage"></p>
        </div>
    </div>
    
    <audio id="backgroundMusic" loop>
        <source src="asset/song/sk.mp3" type="audio/mpeg">
    </audio>
    
    <script src="script.js"></script>
    <script>
        // Configuration des photos et messages
        const photosData = [
            { src: 'asset/photo/lycee.jpg', message: 'Depuis le lycÃ©e, on est lÃ  l\'une pour l\'autre. Merci d\'Ãªtre restÃ©e.' },
            { src: 'asset/photo/nous_1.jpg', message: 'Tous ces moments qu\'on a partagÃ©s, c\'Ã©tait crazy !' },
            { src: 'asset/photo/nous_2.jpg', message: 'Tu es douce, attentionnÃ©e, et tu rends tout plus beau (GPT a gÃ©nÃ©rÃ© ce message et j\'ai jamais autant Ã©tÃ© d\'accord avec lui).' },
            { src: 'asset/photo/nous_3.jpg', message: 'Chaque rire, chaque sourire, chaque instant avec toi compte.' },
            { src: 'asset/photo/nous_4.jpg', message: 'Tu es courageuse et jolie sans mÃªme t\'en rendre compte et ton style est incroyable.' },
            { src: 'asset/photo/nous_5.jpg', message: 'On a tellement rire ensemble et on a fait plein de conneries ensemble.'},
            { src: 'asset/photo/nous_6.jpg', message: 'On a grandi ensemble (pas que physiquement la phrase chelou tu sais) et je suis fiÃ¨re de t\'avoir Ã  mes cÃ´tÃ©s.' },
            { src: 'asset/photo/lant_1.jpg', message: 'Tous ces souvenirs, je ne les oublierai jamais et je suis heureuse d\'avoir pu partager cette annÃ©e avec toi.' },
            { src: 'asset/photo/lant_2.jpg', message: 'Merci d\'Ãªtre toi, tout simplement .' },
            { src: 'asset/photo/lant_3.MP4', message: 'Tu mÃ©rites tout le bonheur du monde et une meilleure mayssa.' },
            { src: 'asset/photo/lant_4.jpg', message: 'J\'Ã©tais obligÃ© de mettre des photos de Lantosque, j\'ai vÃ©cu un super voyage et on n\'a pas fait le tour du monde.' },
            { src: 'asset/photo/mot_amour.jpg', message: 'Je t\'aime du fond du cÅ“ur, vraiment.' }
        ];
        
        // Carrousel 3D
        let currentIndex = 0;
        const carouselTrack = document.getElementById('carouselTrack');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const indicators = document.getElementById('indicators');
        
        // CrÃ©er les slides du carrousel
        photosData.forEach((photo, index) => {
            const slide = document.createElement('div');
            slide.className = 'carousel-slide';
            slide.dataset.index = index;
            
            const img = document.createElement('img');
            img.loading = 'lazy';
            img.onerror = function() {
                this.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="400" height="400"%3E%3Crect fill="%23f0e6f7" width="400" height="400"/%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" dy=".3em" fill="%239d7fb8" font-family="sans-serif" font-size="20"%3EMedia%3C/text%3E%3C/svg%3E';
            };

            // detect video files by extension (case-insensitive)
            const isVideo = /\.(mp4|webm|ogg)$/i.test(photo.src);
            if (isVideo) {
                // try to use a poster image with same name but .jpg
                const posterFromSrc = photo.src.replace(/\.[^/.]+$/, '.jpg');
                img.src = photo.poster || posterFromSrc;
                img.alt = 'Vignette vidÃ©o';
                slide.classList.add('video-slide');

                // play button overlay on the slide
                const playBtn = document.createElement('div');
                playBtn.className = 'video-play-btn';
                playBtn.setAttribute('aria-hidden', 'true');
                playBtn.innerHTML = 'â–¶';
                slide.appendChild(playBtn);

                // on click open overlay with message + video
                slide.addEventListener('click', () => {
                    showOverlay(photo.message, { type: 'video', src: photo.src, poster: photo.poster || posterFromSrc });
                });
            } else {
                img.src = photo.src;
                img.alt = 'Souvenir';
                // Message au clic â€” ouvrir le message mÃªme si la slide n'est pas strictement la "current"
                slide.addEventListener('click', () => {
                    showOverlay(photo.message);
                });
            }

            slide.appendChild(img);
            
            carouselTrack.appendChild(slide);
            
            // CrÃ©er indicateur
            const indicator = document.createElement('button');
            indicator.className = 'indicator';
            indicator.dataset.index = index;
            indicator.addEventListener('click', () => goToSlide(index));
            indicators.appendChild(indicator);
        });
        
        // Utiliser requestAnimationFrame pour des animations plus fluides
        let animationFrameId = null;
        
        function updateCarousel() {
            // Annuler l'animation prÃ©cÃ©dente si elle existe
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            
            animationFrameId = requestAnimationFrame(() => {
                const slides = document.querySelectorAll('.carousel-slide');
                const totalSlides = slides.length;
                // largeur du slide courant pour espacement responsive
                const slideWidth = slides[0] ? slides[0].offsetWidth : 350;

                slides.forEach((slide, index) => {
                    const offset = index - currentIndex;
                    const absOffset = Math.abs(offset);
                    
                    // Calculer la position pour un carrousel classique (espacement dynamique)
                    const translateX = Math.round(offset * (slideWidth * 1.05)); // Espacement horizontal dynamique
                    const translateZ = -absOffset * Math.round(slideWidth * 0.45); // profondeur relative Ã  la taille
                    const angle = offset * 20; // Rotation un peu plus prononcÃ©e pour l'animation
                    const scale = absOffset === 0 ? 1 : Math.max(0.7, 1 - absOffset * 0.15);
                    const opacity = absOffset > 2 ? 0.3 : Math.max(0.3, 1 - absOffset * 0.2);
                    
                    // Ajouter un lÃ©ger mouvement vertical pour les images adjacentes
                    const translateY = absOffset === 0 ? 0 : Math.sin(absOffset * 0.5) * 10;
                    
                    // Appliquer le flou sur les images adjacentes (gauche et droite)
                    let blur = 0;
                    if (absOffset === 1) {
                        blur = 8; // Flou modÃ©rÃ© pour les images adjacentes
                    } else if (absOffset === 2) {
                        blur = 12; // Flou plus fort pour les images plus Ã©loignÃ©es
                    } else if (absOffset > 2) {
                        blur = 15; // Flou maximum
                    }
                    
                    // Appliquer les transformations 3D avec parallaxe si activÃ©
                    const parallaxX = (absOffset === 0 && parallaxEnabled) ? parallaxRotateX : 0;
                    const parallaxY = (absOffset === 0 && parallaxEnabled) ? parallaxRotateY : 0;
                    
                    // Utiliser translate3d pour l'accÃ©lÃ©ration matÃ©rielle avec mouvement vertical
                    slide.style.transform = `
                        translate3d(${translateX}px, ${translateY}px, ${translateZ}px) 
                        rotateY(${angle + parallaxY}deg)
                        rotateX(${parallaxX}deg)
                        scale3d(${scale}, ${scale}, 1)
                    `;
                    slide.style.opacity = opacity;
                    slide.style.zIndex = totalSlides - absOffset;
                    
                    // Appliquer le flou et la luminositÃ©
                    slide.style.filter = `
                        blur(${blur}px) 
                        brightness(${absOffset === 0 ? 1 : 0.8 - absOffset * 0.1})
                    `;
                    
                    // Ajouter classe active pour animations
                    if (absOffset === 0) {
                        slide.classList.add('active');
                    } else {
                        slide.classList.remove('active');
                    }
                });
                
                // Mettre Ã  jour les indicateurs
                document.querySelectorAll('.indicator').forEach((ind, idx) => {
                    ind.classList.toggle('active', idx === currentIndex);
                });
            });
        }
        
        // Variables pour effet parallaxe
        let parallaxRotateX = 0;
        let parallaxRotateY = 0;
        let parallaxEnabled = true;
        let previousIndex = 0;
        
        function goToSlide(index) {
            if (index < 0) index = photosData.length - 1;
            if (index >= photosData.length) index = 0;
            
            // DÃ©sactiver parallaxe pendant la transition
            parallaxEnabled = false;
            parallaxRotateX = 0;
            parallaxRotateY = 0;
            
            // Ajouter des classes d'animation selon la direction
            const slides = document.querySelectorAll('.carousel-slide');
            const direction = index > previousIndex ? 'right' : 'left';
            
            slides.forEach((slide, slideIndex) => {
                slide.classList.remove('transitioning', 'slide-in-left', 'slide-in-right', 'slide-out-left', 'slide-out-right');
                
                if (slideIndex === previousIndex && slideIndex !== index) {
                    // Slide qui sort
                    slide.classList.add(direction === 'right' ? 'slide-out-left' : 'slide-out-right');
                } else if (slideIndex === index && slideIndex !== previousIndex) {
                    // Slide qui entre
                    slide.classList.add(direction === 'right' ? 'slide-in-right' : 'slide-in-left');
                }
            });
            
            previousIndex = currentIndex;
            currentIndex = index;
            updateCarousel();
            
            // RÃ©activer aprÃ¨s la transition
            setTimeout(() => {
                parallaxEnabled = true;
                slides.forEach(slide => {
                    slide.classList.remove('transitioning', 'slide-in-left', 'slide-in-right', 'slide-out-left', 'slide-out-right');
                });
            }, 600);
        }
        
        function nextSlide() {
            goToSlide(currentIndex + 1);
        }
        
        function prevSlide() {
            goToSlide(currentIndex - 1);
        }
        
        // Navigation
        nextBtn.addEventListener('click', nextSlide);
        prevBtn.addEventListener('click', prevSlide);
        
        // Swipe pour mobile
        let touchStartX = 0;
        let touchEndX = 0;
        
        carouselTrack.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
        });
        
        carouselTrack.addEventListener('touchend', (e) => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        });
        
        function handleSwipe() {
            const swipeThreshold = 50;
            const diff = touchStartX - touchEndX;
            
            if (Math.abs(diff) > swipeThreshold) {
                if (diff > 0) {
                    nextSlide();
                } else {
                    prevSlide();
                }
            }
        }
        
        // Navigation clavier
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') prevSlide();
            if (e.key === 'ArrowRight') nextSlide();
        });
        
        // Effet parallaxe au survol de la souris avec throttling pour fluiditÃ©
        const carouselWrapper = document.querySelector('.carousel-wrapper');
        let parallaxFrameId = null;
        
        if (carouselWrapper) {
            carouselWrapper.addEventListener('mousemove', (e) => {
                if (!parallaxEnabled) return;
                
                // Throttle avec requestAnimationFrame pour fluiditÃ©
                if (parallaxFrameId) {
                    cancelAnimationFrame(parallaxFrameId);
                }
                
                parallaxFrameId = requestAnimationFrame(() => {
                    const rect = carouselWrapper.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    const centerX = rect.width / 2;
                    const centerY = rect.height / 2;
                    
                    // Interpolation douce pour Ã©viter les saccades
                    parallaxRotateX += ((y - centerY) / 25 - parallaxRotateX) * 0.15;
                    parallaxRotateY += ((centerX - x) / 25 - parallaxRotateY) * 0.15;
                    
                    updateCarousel();
                });
            });
            
            carouselWrapper.addEventListener('mouseleave', () => {
                if (parallaxFrameId) {
                    cancelAnimationFrame(parallaxFrameId);
                }
                parallaxRotateX = 0;
                parallaxRotateY = 0;
                updateCarousel();
            });
        }
        
        // Initialiser le carrousel
        updateCarousel();
        
        function showOverlay(message, media) {
            document.getElementById('overlayMessage').textContent = message;
            const overlay = document.getElementById('overlay');
            const mediaContainer = document.getElementById('overlayMedia');
            // clear previous media
            mediaContainer.innerHTML = '';

            if (media && media.type === 'video') {
                const video = document.createElement('video');
                video.src = media.src;
                video.controls = true;
                video.playsInline = true;
                video.autoplay = true;
                if (media.poster) video.poster = media.poster;
                mediaContainer.appendChild(video);
                // try to play (user initiated click should allow playback)
                video.play().catch(() => {});
            }

            overlay.classList.add('active');
            // prevent background scroll on mobile
            document.documentElement.style.overflow = 'hidden';
            document.body.style.overflow = 'hidden';
            // ensure overlay is visible on small viewports
            setTimeout(() => {
                overlay.scrollIntoView({ behavior: 'auto', block: 'center' });
            }, 50);
        }

        function closeOverlay() {
            const overlay = document.getElementById('overlay');
            const mediaContainer = document.getElementById('overlayMedia');
            // pause and remove any video
            const vid = mediaContainer.querySelector('video');
            if (vid) {
                try { vid.pause(); } catch (e) {}
            }
            mediaContainer.innerHTML = '';
            overlay.classList.remove('active');
            // restore scroll
            document.documentElement.style.overflow = '';
            document.body.style.overflow = '';
        }
        
        // Fermer l'overlay en cliquant Ã  l'extÃ©rieur
        document.getElementById('overlay').addEventListener('click', function(e) {
            if (e.target === this) {
                closeOverlay();
            }
        });

        // --- Confetti pour la page souvenirs (non intrusif, ne modifie pas le layout/responsive) ---
        const confettiContainer = document.getElementById('confettiContainer');

        function createConfetti() {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = Math.random() * 100 + '%';
            const duration = 3 + Math.random() * 2; // 3-5s
            confetti.style.animationDuration = duration + 's';
            confetti.style.animationDelay = (Math.random() * 0.6) + 's';
            confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
            confettiContainer.appendChild(confetti);
            setTimeout(() => { try { confetti.remove(); } catch (e) {} }, duration * 1000 + 800);
        }

        function createConfettiBurst(count = 60) {
            for (let i = 0; i < count; i++) {
                setTimeout(() => createConfetti(), i * 18);
            }
        }

        // Naviguer vers la page finale au clic (sans dÃ©clencher les paillettes)
        const btnNextToFinal = document.getElementById('btnNextToFinal');
        if (btnNextToFinal) {
            btnNextToFinal.addEventListener('click', (e) => {
                e.preventDefault();
                // navigation rapide, laisser les animations dÃ©jÃ  lancÃ©es sur le chargement
                setTimeout(() => { window.location.href = 'final.html'; }, 200);
            });
        }

        // Lancer des paillettes en continu en arriÃ¨re-plan (adaptÃ© aux mobiles)
        function startInfiniteConfetti() {
            // Determine device class to tune intensity
            const w = Math.max(window.innerWidth || 0, document.documentElement.clientWidth || 0);
            let perTick = 12;
            let interval = 900; // ms between bursts

            if (w < 480) {
                perTick = 6; interval = 1200;
            } else if (w < 1024) {
                perTick = 10; interval = 1000;
            } else {
                perTick = 14; interval = 700;
            }

            // Small stagger between pieces inside a burst for nicer spread
            const makeBurst = (count) => {
                for (let i = 0; i < count; i++) {
                    setTimeout(() => createConfetti(), i * 30);
                }
            };

            // Create an initial gentle burst
            setTimeout(() => makeBurst(Math.round(perTick * 0.9)), 220);

            // Start periodic bursts
            const timer = setInterval(() => {
                makeBurst(perTick);
            }, interval);

            // Store timer so we can stop it later if needed
            window.__souvenirsConfettiTimer = timer;
        }

        // Start confetti when page finishes loading (once) â€” continuous afterwards
        if (document.readyState === 'complete') {
            startInfiniteConfetti();
        } else {
            window.addEventListener('load', () => { startInfiniteConfetti(); }, { once: true });
        }
    </script>
</body>
</html>

